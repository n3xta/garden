<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Garden</title>

  <link rel="stylesheet" href="/css/garden.css">
  <link rel="stylesheet" href="/css/transition.css">
  
  <!-- 预先加载transition.js以确保早于garden.js执行 -->
  <script src="/js/transition.js"></script>
  
  <!-- 将这些库放在后面，避免阻塞transition的初始化 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three-gltf-loader@1.111.0/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.9/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DragControls.js"></script>
</head>

<body>
  <!-- Back to Home button in the top left corner -->
  <a href="/" data-transition="true">
    <img src="/img/back.png" class="back-button" alt="Back to Home">
  </a>
  
  <!-- Explore button -->
  <a href="/explore" data-transition="true">
    <img src="/img/explore.png" class="explore-button" alt="Explore">
  </a>

  <!-- Save button (only show if not in read-only mode) -->
  <% if (!locals.isReadOnly) { %>
  <a href="#" id="save-button">
    <img src="/img/save.png" class="save-button" alt="Save Garden">
  </a>
  <% } %>

  <!-- Read-only mode banner (only show in read-only mode) -->
  <% if (locals.isReadOnly) { %>
  <div class="readonly-banner">
    <p>Viewing <strong><%= user.username %>'s</strong> garden</p>
    <% if (locals.visitorName) { %>
    <a href="/mygarden" class="my-garden-link" data-transition="true">Back to My Garden</a>
    <% } %>
  </div>
  <% } %>

  <div id="three-container"></div>

  <div class="controls">
    <button id="play-button">PLAY</button>
    <input type="range" id="tempo-slider" min="40" max="240" value="80">
    <% if (!locals.isReadOnly) { %>
    <button id="random-note">PLANT A RANDOM NOTE</button>
    <% } %>
  </div>

  <!-- Store garden data in a hidden element -->
  <div id="garden-data" style="display: none;" 
       data-garden='<%- JSON.stringify(gardenData || { plants: [], tempo: 80 }) %>'
       data-readonly='<%= locals.isReadOnly ? "true" : "false" %>'
       data-background-id='<%= locals.backgroundId || "" %>'></div>
  
  <!-- Transition Layer -->
  <div class="cd-transition-layer"> 
    <div class="bg-layer"></div>
  </div>

  <!-- Saved Notification -->
  <div id="save-notification" class="save-notification">Saved!</div>

  <!-- 加载garden相关JS -->
  <script src="/js/garden.js"></script>
</body>
</html>